# 📚 JavaScript - Promise, Fetch API, Async/Await 정리

---

## ✅ 1. Promise 기본 개념

### 🔹 정의

비동기 작업의 성공 또는 실패를 표현하는 자바스크립트 객체

### 🔹 주요 메서드 및 설명

| 메서드                     | 설명                                               |
| ----------------------- | ------------------------------------------------ |
| `new Promise(executor)` | `resolve`, `reject` 함수를 매개로 받아 실행되는 비동기 처리 객체 생성 |
| `.then()`               | 성공 시 실행할 콜백을 연결                                  |
| `.catch()`              | 실패 시 실행할 콜백을 연결                                  |
| `.finally()`            | 성공이든 실패든 항상 실행되는 콜백 연결                           |

### 🔹 예시 코드 (3단계 체이닝)

```js
// 프로미스를 위한 실행기 정의
function executor(resolve, reject) { // 약속을 이행하기 위한 함수
    // resolve : 약속이 이행되었을 때 실행할 콜백
    // reject : 약속이 거부되었을 때 실행할 콜백
    const flag = true;
    if (flag) {
        resolve('야호 신난다 ! 김치찌개 냠냠');
    } else {
        reject('실패 ! 주방에 불이 났어요 !');
    }
}

// 프로미스를 생성하는 방법
// (비동기 통신을 순차적으로 실행하고자 하나, 콜백지옥이 만들어 지는 걸 해결)
const myPromise1 = new Promise(executor); // 첫번째 작업

// 두번째 작업: 첫번째 작업에서 성공 메세지를 받아서 그 메세지에 추가 메세지를 더 해서 출력하고 싶음!
const myPromise2 = myPromise1.then((x) => {  // 첫번째 작업에서 이어서 진행 // then : 그러면
    const result = x + ' 계산은 어디서 하죠 ??';
    return new Promise((resolve, reject) => {
        resolve(result); // 성공했을 때 실행할 콜백
    });
});

// 세번째 작업: 두번째 작업에서 나온 메세지를 이어 받아 작업
const myPromise3 = myPromise2.then((message) => {
    console.log(message);
})
```

---

## ✅ 2. XMLHttpRequest + Promise (콜백 지옥 해결)

### 🔹 커스텀 fetch 함수 `fetchGet()` 정의

```js
// XMLHttpRequest를 Promise로 래핑한 함수 정의
function fetchGet(url) {
    return new Promise((resolve, reject) => {

        const xhr = new XMLHttpRequest();
        xhr.open('GET', url); // 요청 세팅
        xhr.send(); // 요청 보내기

        // 응답 데이터 가져오기
        xhr.addEventListener('load', e => {
            const responseData = JSON.parse(xhr.responseText);
            resolve(responseData);
        });

        // 서버 에러시 발동하는 이벤트
        xhr.addEventListener('error', e => {
            reject('서버 통신 중 에러 발생!');
        });

    });
}
```

### 🔹 실전 예제: 사용자 → 게시물 → 댓글 순서로 요청

```js
// fetchGet() 체이닝 방식으로 콜백지옥 해결
$fetchBtn.addEventListener('click', e => {
    fetchGet(`${serverUrl}/users`)
        .then((userList) => fetchGet(`${serverUrl}/posts?userId=${userList[1].id}`))
        .then((postList) => fetchGet(`${serverUrl}/comments?postId=${postList[3].id}`))
        .then((commentList) => {
            console.log(commentList);
            commentList.forEach(comment => {
                const $div = document.createElement('div');
                $div.textContent = comment.name;
                document.body.append($div);
            });
        });
});
```

---

## ✅ 3. Fetch API 기본

### 🔹 기본 사용법

```js
// fetch는 기본적으로 GET 요청을 보냄
fetch('https://jsonplaceholder.typicode.com/posts')
    .then(res => res.json()) // 응답을 JSON으로 변환
    .then(posts => {
        // 성공했을 때 실행
        displayPosts(posts.slice(0, 5)); // 상위 5개의 게시물만 표시
    })
    .catch(error => {
        // 실패했을 때만 실행
        postsContainer.innerHTML = `<p style="color: red;">${error}</p>`;
    })
    .finally(() => {
        // 성공해도 실행, 실패해도 실행
        console.log("데이터 요청 완료");
    });
```

### 🔹 POST 요청 예시 (Gemini API 호출)

```js
const payload = {
    'contents': [
        {
            'parts': [
                {
                    'text': '오늘의 날씨는 어떨까? 저녁 6시 날씨 알아와봐'
                }
            ]
        }
    ]
};
fetch(url, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(payload)
})
    .then(res => res.json())
    .then(result => {
        const responseText = result.candidates[0].content.parts[0].text;
        document.body.innerHTML = `
        <div style="width: 40%; font-size: 3rem; margin: auto;">
        ${responseText}</div>`;
    });
```

---

## ✅ 4. Async / Await 문법

### 🔹 기본 구조

```js
// async await 으로 fetch 코드 간소화
async function fetchGetAsync() {
    const res = await fetch(url); // 응답 대기
    const userList = await res.json(); // JSON 파싱 대기
    console.log(userList);
}
```

### 🔹 버튼 클릭 시 비동기 호출

```js
const $btn = document.getElementById('btn');
$btn.addEventListener('click', e => {
    fetchGetAsync();
});
```

---

## ✅ 5. 실전 예제: 게시물 리스트 가져오기

### 🔹 Async / Await 사용

```js
// 게시물을 화면에 표시하는 함수
function displayPosts(posts) {
    const postsContainer = document.getElementById("posts");
    postsContainer.innerHTML = ""; // 기존 콘텐츠 초기화

    posts.forEach(post => {
        const postElement = document.createElement("div");
        postElement.classList.add("post");

        postElement.innerHTML = `
        <div class="post-title">${post.title}</div>
        <div class="post-body">${post.body}</div>
        `;

        postsContainer.append(postElement);
    });
}

// 서버에서 데이터를 가져 오는 함수
async function fetchPosts() {
    // 로딩 중 메시지 표시
    const postsContainer = document.getElementById("posts");
    postsContainer.innerHTML = "<p>데이터를 불러오는 중입니다...</p>";

    try {
        const res = await fetch("https://jsonplaceholder.typicode.com/posts");
        const posts = await res.json();
        displayPosts(posts.slice(0, 5)); // 상위 5개의 게시물만 표시
    } catch (error) {
        postsContainer.innerHTML = `<p style="color: red;">${error}</p>`;
    } finally {
        // 성공해도 실행, 실패해도 실행
        console.log("데이터 요청 완료");
    }
}

// 버튼 클릭 시 실행
document.getElementById("fetchPosts").addEventListener("click", () => {
    fetchPosts();
});
```

---

## ✅ 사용 정리 표

| 구분          | 문법                                        | 설명                   |
| ----------- | ----------------------------------------- | -------------------- |
| Promise     | `new Promise((resolve, reject) => {...})` | 비동기 처리 객체 생성         |
| then        | `promise.then(result => {...})`           | 성공 시 실행될 코드 등록       |
| catch       | `promise.catch(error => {...})`           | 실패 시 실행될 코드 등록       |
| finally     | `promise.finally(() => {...})`            | 성공/실패와 상관없이 항상 실행    |
| fetch       | `fetch(url)`                              | HTTP 요청 보내기 (기본 GET) |
| async/await | `async function`, `await`                 | 동기식처럼 비동기 코드 작성      |

---

