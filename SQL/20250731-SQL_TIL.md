# SQL 계층형 질의 (Hierarchical Query)

### **1. 계층형 질의란?**

데이터베이스 테이블에 저장된 데이터들이 서로 **계층적인 관계** (예: 회사의 조직도, 온라인 게시판의 댓글과 대댓글)를 가질 때, 이 구조를 파악하고 순서대로 출력하기 위해 사용하는 쿼리입니다. Oracle에서 주로 사용되며, `START WITH`와 `CONNECT BY` 절을 핵심으로 사용합니다.

-----

### **2. 핵심 문법 및 키워드**

계층형 질의는 `SELECT` 문의 `WHERE` 또는 `GROUP BY` 절 뒤에 작성합니다.

| 키워드 & 함수 | 설명 |
| --- | --- |
| `START WITH` | 계층 구조의 시작점, 즉 **루트(root) 데이터를 지정**하는 조건절입니다. |
| `CONNECT BY` | 부모 행과 자식 행 사이의 **관계를 정의**하는 조건절입니다. |
| `PRIOR` | `CONNECT BY` 절에 사용되며, **부모 행의 컬럼을 식별**하는 데 사용되는 연산자입니다. |
| `LEVEL` | 계층 구조에서 현재 행의 **깊이(depth)를 반환**하는 의사 컬럼(Pseudo-column)입니다. 루트 노드는 1이며, 하위 노드로 갈수록 1씩 증가합니다. |
| `LPAD` | 문자열의 왼쪽에 특정 문자를 채워 길이를 맞추는 함수입니다. `LEVEL`과 함께 사용해 **들여쓰기**를 표현할 수 있습니다. |

-----

### **3. `PRIOR` 연산자와 전개 방향**

`PRIOR` 연산자의 위치에 따라 계층을 탐색하는 방향이 결정됩니다.

  - **순방향 전개 (부모 → 자식)**: `START WITH`에서 지정한 부모 노드부터 시작하여 자식 노드로 내려가며 탐색합니다.

      - **문법**: `CONNECT BY PRIOR 부모_컬럼 = 자식_컬럼`
      - **예시**: `CONNECT BY PRIOR comment_id = parent_comment_id`
      - **의미**: 부모 행의 `comment_id`와 같은 `parent_comment_id`를 가진 자식 행을 찾습니다.

  - **역방향 전개 (자식 → 부모)**: `START WITH`에서 지정한 자식 노드부터 시작하여 부모 노드로 올라가며 탐색합니다.

      - **문법**: `CONNECT BY 부모_컬럼 = PRIOR 자식_컬럼`
      - **예시**: `CONNECT BY manager_id = PRIOR user_id`
      - **의미**: 자식 행의 `manager_id`와 같은 `user_id`를 가진 부모 행을 찾습니다.

> **SQLD 핵심 노트**
>
>  일반적으로 **`PRIOR`가 관계의 시작점(부모)에 붙으면 순방향, 끝점(자식)에 붙으면 역방향**으로 기억하면 편리합니다.

-----

### **4. 사용 예제**

#### **예제 1: 조직도 조회 (USERS 테이블)**

`START WITH`로 최상위 관리자를 지정하고, `CONNECT BY`로 관리자-부하직원 관계를 연결하여 조직도를 조회합니다.

**SQL 코드**

```sql
SELECT
    LEVEL,
    LPAD(' ', (LEVEL-1) * 4) || username AS "사용자 (조직도)", -- LEVEL에 따라 들여쓰기
    user_id,
    manager_id
FROM
    USERS
START WITH
    USER_ID = 11 -- 'King'부터 조직도 시작
CONNECT BY
    PRIOR user_id = manager_id; -- 순방향 전개: 나의 user_id가 다른 사람의 manager_id와 같다면, 그 사람은 나의 부하직원.
```

  * 위 코드는 제공해주신 파일의 `user_id = PRIOR manager_id`를 일반적인 순방향 전개인 `PRIOR user_id = manager_id`로 수정한 표준 구문입니다. 후자가 "부모의 `user_id`가 자식의 `manager_id`와 같다"는 관계를 더 명확하게 표현합니다.

**실행 결과 분석**

  - `START WITH USER_ID = 11`: `user_id`가 11인 사용자를 루트 노드(LEVEL 1)로 설정합니다.
  - `CONNECT BY PRIOR user_id = manager_id`:
      - `LEVEL 1`의 `user_id`(11)를 `manager_id`로 가지는 `LEVEL 2`의 사용자들을 찾습니다.
      - `LEVEL 2`의 `user_id`를 `manager_id`로 가지는 `LEVEL 3`의 사용자들을 찾습니다.
      - 이 과정을 반복하여 전체 조직도를 완성합니다.
  - `LPAD(' ', (LEVEL-1) * 4)`: `LEVEL`에 따라 공백을 추가하여 계층 구조를 시각적으로 표현합니다.

#### **예제 2: 댓글 목록 조회 (COMMENTS 테이블)**

최상위 댓글부터 시작하여 대댓글을 순서대로 조회합니다.

**SQL 코드**

```sql
SELECT
    LPAD('└> ', (LEVEL-1) * 4) || comment_text AS "댓글 내용",
    LEVEL,
    comment_id,
    parent_comment_id
FROM
    COMMENTS
START WITH
    parent_comment_id IS NULL -- 최상위 댓글(부모가 없는 댓글)부터 시작
CONNECT BY
    PRIOR comment_id = parent_comment_id; -- 순방향 전개: 부모 댓글의 ID와 같은 parent_comment_id를 가진 자식 댓글을 찾음
```

**실행 결과 분석**

  - `START WITH parent_comment_id IS NULL`: 부모 댓글이 없는, 즉 원본 댓글들을 루트 노드(LEVEL 1)로 설정합니다.
  - `CONNECT BY PRIOR comment_id = parent_comment_id`: `comment_id`(부모의 PK)와 `parent_comment_id`(자식의 FK)를 연결하여 댓글과 대댓글의 관계를 정의합니다. 이는 가장 대표적인 **순방향 전개**의 예시입니다.
  - `LPAD('└> ', ...)`: 댓글의 계층을 `└>` 기호와 들여쓰기로 명확하게 보여줍니다.
